name: Formal verification

# Run on pushes to main/master, PRs targeting main/master, and manual runs
on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0 
        

      - name: Install Rust 1.91 toolchain
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: 1.91.0
          override: true
          components: rustfmt, clippy

      - name: Install and run MIRAI static analysis
        run: |
          # Install MIRAI (Rust abstract interpreter) and run it
          cargo install mirai
          cargo mirai
        env:
          # Optional: increase verbosity if needed
          RUST_BACKTRACE: 1

      - name: Run Kani verifier
        uses: model-checking/kani-github-action@v1.1 
        
        with:
          # (Uses the latest Kani version by default)
          command: 'cargo-kani'
        env:
          # Configure Kani: check all threads and assert no undefined behavior
          RUSTFLAGS: "-Zkani-check-untyped"
      
      - name: Install and run cargo-audit
        run: |
          cargo install cargo-audit
          cargo audit --deny warnings

      - name: (Optional) Run Cargo test suite
        run: cargo test --all -- --nocapture
