name: Formal verification
permissions:
  contents: read

# Run manually (workflow_dispatch)
on:
  workflow_dispatch:

jobs:
  verify:
    # Kani currently requires Ubuntu 20.04 in CI; use that to ensure Kani runs.
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        continue-on-error: true
        
      - name: Install Rust 1.91 toolchain
        uses: actions-rs/toolchain@v1.0.7
        continue-on-error: true
        with:
          toolchain: 1.91.0
          override: true
          components: rustfmt, clippy

      - name: Ensure cargo is up-to-date & show versions
        continue-on-error: true
        run: |
          rustc --version
          cargo --version

      - name: Format check (rustfmt)
        continue-on-error: true
        run: cargo fmt -- --check

      - name: Lint strictly (clippy)
        continue-on-error: true
        run: |
          # fail the job on any clippy warning
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Install and run cargo-geiger (unsafe-usage scan)
        continue-on-error: true
        run: |
          # install cargo-geiger (use --locked for reproducible installs)
          cargo install --locked cargo-geiger || cargo install cargo-geiger
          # run cargo-geiger and capture output
          set -o pipefail
          geiger_output="$(cargo geiger --all-targets --all-features 2>&1)" || true
          echo "----- cargo-geiger output -----"
          echo "$geiger_output"
          echo "-------------------------------"
          # cargo-geiger marks crates with "☢" when unsafe usage is present.
          # Fail CI if any '☢' symbols appear in output.
          if echo "$geiger_output" | grep -q '☢'; then
            echo "::error::Unsafe usage detected by cargo-geiger (symbol '☢'). Failing CI."
            exit 1
          fi
          # (If your environment doesn't render the symbol, also check for the word 'unsafe' 
          # at the start of lines produced by geiger as a fallback.)
          if echo "$geiger_output" | grep -E '(^| )unsafe( |$)' | grep -v -E '(^|\s)unsafe-trait'; then
            echo "::warning::cargo-geiger found occurrences of the word 'unsafe' in its output. Inspect manually."
          fi

      - name: Run Kani verifier
        continue-on-error: true
        uses: model-checking/kani-github-action@v1.1
        with:
          # default is `cargo-kani`, keep that unless you need a custom binary
          command: 'cargo-kani'
          # working-directory: '.'   # uncomment/change if your crate is in a subdirectory
        env:
          # Optional: if you want to provide extra RUSTFLAGS for kani, set them here.
          # Leave unset for default behavior.
          # RUSTFLAGS: "-Z kani-check-untyped"
          KANI_DEFAULT_VERBOSITY: "1"

      - name: Install and run cargo-audit (dependency advisories)
        continue-on-error: true
        run: |
          cargo install --locked cargo-audit || cargo install cargo-audit
          # fail the CI if cargo-audit reports anything (adjust policy as needed)
          cargo audit --deny warnings

      - name: Run Cargo test suite
        continue-on-error: true
        run: cargo test --all -- - -nocapture
