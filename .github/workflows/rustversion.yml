name: Cargo Upgrade and Edition

permissions:
  contents: write
  checks: write
  pull-requests: write
  security-events: write
  statuses: write
  issues: write
  actions: read 

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch: {}

jobs:
  update-cargo-toml:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (default branch)
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Install Rust toolchain and Clippy
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          toolchain: stable
          cache: false
          matcher: true

      - name: Fetch latest Rust version and determine edition
        run: |
          latest_version=$(rustc --version | awk '{print $2}')
          echo "latest_version=$latest_version" >> $GITHUB_ENV

          # per your instruction: 2024 is the current edition
          latest_edition="2024"
          echo "latest_edition=$latest_edition" >> $GITHUB_ENV

          echo "Fetched latest_version: $latest_version and latest_edition: $latest_edition"

      - name: Update Cargo.toml files using tomlkit (TOML-aware)
        id: toml_update
        run: |
          python - <<'PY'
          import os, sys, subprocess
          from pathlib import Path

          # Ensure tomlkit is available (install if necessary)
          try:
              import tomlkit
          except Exception:
              subprocess.check_call([sys.executable, "-m", "pip", "install", "tomlkit"])
              import tomlkit

          latest_version = os.environ.get("latest_version")
          latest_edition = os.environ.get("latest_edition")

          if not latest_version or not latest_edition:
              print("Environment variables latest_version or latest_edition missing", file=sys.stderr)
              sys.exit(1)

          changed_files = []

          for p in Path(".").rglob("Cargo.toml"):
              try:
                  text = p.read_text(encoding="utf-8")
              except Exception as e:
                  print(f"Skipping {p}: cannot read ({e})")
                  continue

              try:
                  doc = tomlkit.parse(text)
              except Exception as e:
                  print(f"Skipping {p}: parse error ({e})")
                  continue

              # Only modify files that declare a [package] table
              if "package" not in doc:
                  print(f"Skipping {p}: no [package] table")
                  continue

              pkg = doc["package"]
              file_changed = False

              # Enforce rust-version as a string
              current_rv = pkg.get("rust-version")
              if current_rv != latest_version:
                  pkg["rust-version"] = latest_version
                  file_changed = True

              # Enforce edition (tomlkit will render as string)
              current_ed = pkg.get("edition")
              # Convert existing edition to string for robust comparison
              if current_ed is None or str(current_ed) != str(latest_edition):
                  pkg["edition"] = str(latest_edition)
                  file_changed = True

              if file_changed:
                  # Write back preserving TOML structure/comments
                  p.write_text(tomlkit.dumps(doc), encoding="utf-8")
                  changed_files.append(str(p))

          if changed_files:
              print("Modified files:", changed_files)
              # communicate result to GitHub Actions
              with open(os.environ["GITHUB_ENV"], "a") as f:
                  f.write("changes_made=true\n")
          else:
              print("No Cargo.toml updates required")
              with open(os.environ["GITHUB_ENV"], "a") as f:
                  f.write("changes_made=false\n")
          PY

      - name: Create pull request (if changes were made)
        if: env.changes_made == 'true'
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cargo-rust-auto-update
          base: ${{ github.event.repository.default_branch }}
          title: "Enforce latest Rust version and edition in Cargo.toml"
          body: |
            This automated PR strictly enforces the following in ALL Cargo.toml files:

            - rust-version = ${{ env.latest_version }}
            - edition = ${{ env.latest_edition }}

            The PR is generated automatically by the workflow and will be updated on subsequent runs.
          commit-message: "Enforce latest Rust version (${{ env.latest_version }}) and edition (${{ env.latest_edition }}) in Cargo.toml files"
          delete-branch: true
