name: Cargo Upgrade and Edition

permissions:
  contents: write
  checks: write
  pull-requests: write
  security-events: write
  statuses: write
  issues: write
  actions: read 

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch: {}

jobs:
  update-cargo-toml:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (default branch)
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Install Rust toolchain and Clippy
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          toolchain: stable
          cache: false
          matcher: true

      - name: Fetch latest Rust version and determine edition
        run: |
          latest_version=$(rustc --version | awk '{print $2}')
          echo "latest_version=$latest_version" >> $GITHUB_ENV

          latest_edition="2024"
          echo "latest_edition=$latest_edition" >> $GITHUB_ENV

          echo "Fetched latest_version: $latest_version and latest_edition: $latest_edition"

      - name: Strictly update ALL Cargo.toml files
        id: update
        run: |
          set -euo pipefail
          changes_made=false

          echo "Enforcing rust-version=$latest_version"
          echo "Enforcing edition=$latest_edition"

          while IFS= read -r file; do
            echo "Processing $file"

            # Ensure [package] section exists
            if ! grep -q '^\[package\]' "$file"; then
              echo "No [package] section in $file â€” skipping"
              continue
            fi

            # Always enforce rust-version
            if grep -q '^rust-version\s*=' "$file"; then
              sed -i "s/^rust-version\s*=.*/rust-version = \"$latest_version\"/" "$file"
            else
              sed -i "/^\[package\]/a rust-version = \"$latest_version\"" "$file"
            fi

            # Always enforce edition
            if grep -q '^edition\s*=' "$file"; then
              sed -i "s/^edition\s*=.*/edition = \"$latest_edition\"/" "$file"
            else
              sed -i "/^\[package\]/a edition = \"$latest_edition\"" "$file"
            fi

            changes_made=true
          done < <(find . -name "Cargo.toml")

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if ! git diff --quiet; then
            git add .
            git commit -m "Enforce latest Rust version ($latest_version) and edition ($latest_edition) in all Cargo.toml files"
            echo "changes_made=true" >> $GITHUB_ENV
          else
            echo "No effective changes detected"
            echo "changes_made=false" >> $GITHUB_ENV
          fi

      - name: Create pull request (single source of truth)
        if: env.changes_made == 'true'
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cargo-rust-auto-update
          base: ${{ github.event.repository.default_branch }}
          delete-branch: true
          title: "Enforce latest Rust version and edition in Cargo.toml"
          body: |
            This automated PR strictly enforces the following in ALL Cargo.toml files:

            - rust-version = ${{ env.latest_version }}
            - edition = ${{ env.latest_edition }}

            This guarantees consistency across all crates and workspaces.
