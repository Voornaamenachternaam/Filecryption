name: rust-rs

permissions:
  contents: write
  checks: write
  pull-requests: write
  security-events: write
  statuses: write
  issues: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"

jobs:
  clippy_check:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      # 2️⃣ Install Rust toolchain (1.91.0) and Clippy
      - name: Install Rust toolchain and Clippy
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.91.0
          components: clippy

      # 3️⃣ Install SARIF converters
      - name: Install SARIF converters
        run: |
          cargo install --force clippy-sarif
          cargo install --force sarif-fmt
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        shell: bash

      # 4️⃣ Run Clippy with fixes, produce SARIF safely
      - name: Run Clippy and produce SARIF safely
        id: clippy_run
        run: |
          TMP_JSON=$(mktemp)
          TMP_SARIF=$(mktemp)

          # Run Clippy with fixes; JSON output to temp
          cargo clippy --fix --all-features --message-format=json > "$TMP_JSON"

          # Convert JSON -> SARIF
          clippy-sarif < "$TMP_JSON" | tee "$TMP_SARIF" | sarif-fmt

          # Copy SARIF to repo root for upload
          cp "$TMP_SARIF" rust-clippy-results.sarif

          # Check if any source files were modified by cargo fix
          # Ignore SARIF and temp files
          if git diff --name-only | grep -vE 'rust-clippy-results\.sarif|\.tmp' >/dev/null; then
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 5️⃣ Validate SARIF JSON
      - name: Validate SARIF JSON
        run: |
          python -m json.tool rust-clippy-results.sarif > /dev/null
        shell: bash

      # 6️⃣ Upload SARIF results to GitHub code scanning
      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: rust-clippy-results.sarif
          wait-for-processing: true

      # 7️⃣ Create a Pull Request with fixes (only if source files changed)
      - name: Commit fixes and create Pull Request
        if: steps.clippy_run.outputs.fixes_applied == 'true'
        run: |
          # Configure git for CI
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a unique branch for this run
          BRANCH="clippy-fixes-${GITHUB_RUN_ID}"
          git checkout -b "$BRANCH"

          # Stage only source files (ignore SARIF/log files)
          git add $(git diff --name-only | grep -vE 'rust-clippy-results\.sarif|\.tmp')

          # Commit changes
          git commit -m "Apply Clippy auto-fixes"

          # Push branch to remote
          git push origin "$BRANCH"

          # Set output for PR step
          echo "pr_branch=$BRANCH" >> $GITHUB_OUTPUT
        id: commit_fixes
        shell: bash

      - name: Create Pull Request
        if: steps.clippy_run.outputs.fixes_applied == 'true'
        uses: step-security/create-or-update-pull-request-action@v1.10.2
        with:
          title: "Apply Clippy auto-fixes"
          body: |
            This PR applies automatic Clippy fixes to the codebase.
            Clippy warnings have been resolved where possible.
          branch: ${{ steps.commit_fixes.outputs.pr_branch }}
          base: "main"
