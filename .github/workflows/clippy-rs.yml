name: rust-rs

permissions:
  contents: write
  checks: write
  pull-requests: write
  security-events: write
  statuses: write
  issues: write
  actions: read     # recommended for private repos to avoid SARIF upload "Resource not accessible" failures

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"

jobs:
  clippy_check:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # 2️⃣ Install Rust toolchain and Clippy (replaces dtolnay/rust-toolchain)
      - name: Install Rust toolchain and Clippy
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          toolchain: stable
          components: clippy
          cache: true
          matcher: true

      # 3️⃣ Run StepSecurity's Clippy action (annotates PRs / commits)
      #     (keeps the behaviour/annotation benefits of StepSecurity's action)
      - name: Run StepSecurity clippy-action (annotations)
        uses: auguwu/clippy-action@master
        with:
          # token is used by many clippy actions for posting annotations/comments
          token: ${{ secrets.GITHUB_TOKEN }}
          # pass any args you want; we keep it conservative here
        # intentionally do not fail the job here — the cargo clippy step below will be authoritative
        continue-on-error: false

      # 4️⃣ Install SARIF converters (clippy-sarif + sarif-fmt)
      - name: Install SARIF converters
        run: |
          set -euxo pipefail
          cargo install --force --locked clippy-sarif
          cargo install --force --locked sarif-fmt
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        shell: bash

      # 5️⃣ Run Clippy with fixes and produce JSON -> SARIF (this is the authoritative run
      #    for auto-fixing + SARIF generation; kept separate to reliably capture JSON)
      - name: Run cargo clippy --fix and convert to SARIF
        id: clippy_run
        run: |
          set -euxo pipefail

          TMP_JSON="$(mktemp)"
          TMP_SARIF="$(mktemp)"

          # Run clippy with auto-fix and request machine-readable JSON output
          # We include --all-features to match your prior workflow.
          # Adding --allow-dirty and --allow-staged helps CI apply fixes even if the working dir
          # is considered "dirty" by cargo; see comments in the workflow notes below.
          cargo clippy --fix --all-features --allow-dirty --allow-staged --message-format=json > "$TMP_JSON" || true

          # Convert the cargo/clippy JSON to SARIF, pretty-print to stdout, and capture to file
          clippy-sarif < "$TMP_JSON" | tee "$TMP_SARIF" | sarif-fmt

          cp "$TMP_SARIF" rust-clippy-results.sarif

          # Determine whether cargo clippy --fix changed any tracked source files.
          # Filter out SARIF and temporary files.
          CHANGED="$(git status --porcelain --untracked-files=no || true)"
          CHANGED_FILES="$(printf '%s\n' "$CHANGED" | awk '{print $2}' | grep -vE '^rust-clippy-results\.sarif$|\.tmp' || true)"

          if [ -n "$CHANGED_FILES" ]; then
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 6️⃣ Validate SARIF JSON
      - name: Validate SARIF JSON
        run: |
          set -euxo pipefail
          python -m json.tool rust-clippy-results.sarif > /dev/null
        shell: bash

      # 7️⃣ Upload SARIF results to GitHub Code Scanning
      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: rust-clippy-results.sarif
          wait-for-processing: true

      # 8️⃣ Commit fixes and create Pull Request (only if fixes applied)
      - name: Commit fixes and create Pull Request
        if: steps.clippy_run.outputs.fixes_applied == 'true'
        id: commit_fixes
        run: |
          set -euxo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="clippy-fixes-${GITHUB_RUN_ID}"
          git checkout -b "$BRANCH"

          # Determine changed tracked files, ignore SARIF/temp files
          CHANGED_FILES="$(git diff --name-only | grep -vE '^rust-clippy-results\.sarif$|\.tmp' || true)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No source changes to commit." >&2
            echo "pr_branch=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use -- to avoid issues with filenames starting with '-'
          git add -- $CHANGED_FILES

          if git diff --cached --quiet; then
            echo "Nothing to commit after staging changed files." >&2
            echo "pr_branch=" >> $GITHUB_OUTPUT
            exit 0
          fi

          git commit -m "Apply Clippy auto-fixes"
          git push --set-upstream origin "$BRANCH"

          echo "pr_branch=$BRANCH" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Pull Request
        if: steps.clippy_run.outputs.fixes_applied == 'true' && steps.commit_fixes.outputs.pr_branch != ''
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          title: "Apply Clippy auto-fixes"
          body: |
            This PR applies automatic Clippy fixes to the codebase.
            Clippy warnings have been resolved where possible.
          branch: ${{ steps.commit_fixes.outputs.pr_branch }}
          base: "main"
 
